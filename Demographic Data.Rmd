---
title: "Demographics of First 5 Ventura"
author: "Gwendolyn Reynolds"
date: "1/30/2018"
output:
  word_document: default
  html_document: default
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages 
library(knitr)
library(readxl)
library(scales)
library(tidyverse)
library(anonymizer)
library(lubridate)
library(forcats)

theme_set(theme_minimal())
theme_update(text = element_text(family = "Roboto"), axis.text = element_text(family = "Roboto"), strip.text = element_text(family = "Roboto"), axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r read in data, include=FALSE, warning=FALSE, message=FALSE}

import_member <- read_xls("~/Google Drive/SI/DataScience/Side projects/Ventura Preschool /raw_data/IMPORT MEMBER Client Assessment by Answer Value 01-19-2018.xls")
family_intake <- read_xls("~/Google Drive/SI/DataScience/Side projects/Ventura Preschool /raw_data/FAMILY INTAKE Client Assessment by Answer Value 01-19-2018.xls")
preschool <- read_xls("~/Google Drive/SI/DataScience/Side projects/Ventura Preschool /raw_data/Clients with Preschool Services.xls")
ziptocity <- read_csv("~/Google Drive/SI/DataScience/Side projects/Ventura Preschool /raw_data/zipcodeCity.csv")

```

```{r clean and merge, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}

## get the dates in the same format
preschool$`Service StartDate` <- as.Date(preschool$`Service StartDate`, "%Y/%m/%d")
preschool$`Service EndDate` <- as.Date(preschool$`Service EndDate`, "%Y/%m/%d")

##I want to know the year of enrollment, so i'm creating a "year" variable
preschool <- preschool %>% 
  mutate(school_year = year(`Service StartDate`)) 

## this dataset has a bunch of repeat rows. I want to filter those out. 
preschool <- preschool %>% 
  group_by(`Program Title`, ClientID, Zip, school_year) %>% 
  mutate(count = n()) %>% 
  mutate(rank = rank(`Service StartDate`)) %>% 
  filter(rank==1)

preschool <- preschool %>% 
  group_by(`Program Title`, ClientID, Zip, school_year) %>% 
  mutate(count = n()) %>% 
  mutate(rank = rank(`Service StartDate`)) 

### collapse all ethnicities besides white/latino/other
preschool <- preschool %>% 
    mutate(Ethnicity = as.factor(Ethnicity)) 

preschool <- preschool %>% 
    mutate(Ethnicity= (fct_collapse(Ethnicity, "Other" = c("01. Alaskan Native / American Indian", "02. Asian", "03. Black / African American", "05. Vietnamese", "06. Pacific Islander", "08. Multiracial", "09. Other", "10. Don't know/Declined")))) 


preschool <- preschool %>% 
    mutate(Language= (fct_collapse(Language, "Other" = c("03. Mixteco", "05. Vietnamese", "07. Mandarin (Putonghua)", "09. Filipino(Tagalog)", "10. Other", "11. Arabic", "13. Chinese", "15. Unknown", "16. Decline to Answer", "06. Korean", "14. Other", "08. Farsi (Persian)", "12. Cambodian", "04. Hmong", "11. Don't Know/Declined")))) 

family_intake$`Enrollment Date` <- as.Date(family_intake$`Enrollment Date`, "%Y/%m/%d")

##I want to know the year of enrollment, so i'm creating a "year" variable
family_intake <- family_intake %>% 
  mutate(school_year = year(`Enrollment Date`)) 

family_intake <- family_intake %>% 
  group_by(`Program Title`, ClientID, Zip, school_year) %>% 
  mutate(count = n()) %>% 
  mutate(rank = rank(`Enrollment Date`)) 

family_intake <- family_intake %>% 
    mutate(Ethnicity= (fct_collapse(Ethnicity, "Other" = c("01. Alaskan Native / American Indian", "02. Asian", "03. Black / African American", "05. Vietnamese", "06. Pacific Islander", "08. Multiracial", "09. Other", "10. Don't know/Declined")))) 


family_intake <- family_intake %>% 
    mutate(Language= (fct_collapse(Language, "Other" = c("03. Mixteco", "05. Vietnamese", "07. Mandarin (Putonghua)", "09. Filipino(Tagalog)", "10. Other", "11. Arabic", "13. Chinese", "15. Unknown", "16. Decline to Answer", "06. Korean", "14. Other", "08. Farsi (Persian)", "12. Cambodian", "04. Hmong")))) 

ziptocity <- ziptocity %>% slice(1:53) %>% mutate(Zip = as.integer(`Zip Code`)) 

family_intake <- family_intake %>% ungroup() %>% mutate(Zip = as.integer(Zip))

family_intaketest <- family_intake %>% 
  right_join(ziptocity, family_intake, by = "Zip")

family_intaketest <- family_intaketest %>% filter(!is.na(ClientID)) 

family_intaketest <- family_intaketest %>% group_by(`Program Title`, ClientID, Zip, school_year) %>% mutate(count = n()) %>% 
  mutate(rank = rank(`Enrollment Date`)) 

family_intaketest %>% 
  group_by(rank) %>% 
  summarise(count = n())

notpre <- c("01: Preschool (Marina West)", "Preschool (Berylwood)", "Preschool (Hathaway School)", "Preschool (Sierra Linda)", "Preschool {Hueneme Head Start}", "Preschool {Larsen Head Start}", "Preschool {Little Vikings Head Start}", "Preschool {Parkview Head Start}")
`%notin%` <- Negate(`%in%`)

preschool <- preschool %>% 
  filter(`Service Modality` %notin% notpre)

preschool %>% 
  group_by(`Service Modality`) %>% 
  count(`Service Modality`)

preschool <- preschool %>% ungroup %>% mutate(dataset = "preschool") %>% mutate(Zip = as.integer(Zip))
family_intake <- family_intake %>% ungroup %>%  mutate(dataset = "family") %>% mutate(Zip = as.integer(Zip))


mergedpreschool <- left_join(preschool, family_intake, by = c("ClientID" = "ClientID", "FamilyID" = "FamilyID"))
mergedpreschool <- mergedpreschool %>% group_by(ClientID) %>%  mutate(rank = rank(ClientID))

mergedpreschool2 <- bind_rows(preschool, family_intake)

mergedpreschool2 <- mergedpreschool2 %>% group_by(ClientID) %>% mutate(rank = rank(ClientID))

mergedpreschool2 %>% ungroup() %>% count(dataset, rank)

mergedpreschool2 %>% 
  group_by(dataset, `01-1: 1 What is your highest level of education`) %>% 
  count(`01-1: 1 What is your highest level of education`)

mergedpreschool2 %>% 
  group_by(ClientID) %>% 
  group_by(`01-1: 1 What is your highest level of education`) %>% 
  count()


mergedcollapse <- mergedpreschool2 %>%
  filter(school_year>=2014) %>% 
  group_by(ClientID) %>%
  summarise(education=paste(`01-1: 1 What is your highest level of education`, collapse=' '), school_year = paste(school_year, collapse = " "), school_year = paste(school_year, collapse = " "), ProgramTitle = paste(`Program Title`, collapse = " "), dob = paste(DOB, collapse = " "), gender = paste(Gender_, collapse = " "), sped = paste(`Special Needs`, collapse = " "), ethnicity = paste(Ethnicity, collapse = " "), language = paste(Language, collapse = " "), city = paste(City, collapse = " "), zip = paste(Zip, collapse = " "), dataset = paste(dataset, collapse = " "), preschool = paste(`Service Modality`, collapse = " "), employ = paste(`01-2: 2 What is your current employment status?`, collapse = " "), income = paste(`01-4: 4 What was your total FAMILY INCOME in the last 12 months?`, collapse = " "), householdmems = paste(`01-7: 7 How many family members live in your household? (incl_ a`, collapse = " ")) 

mergedcollapse %>% 
  count(dataset) 



mergedcollapse <- mergedcollapse %>% 
  mutate(datasetsimple = ifelse(grepl("preschool family", dataset), "preschool family",
                         ifelse(grepl("family", dataset), "family", 
                         ifelse(grepl("preschool", dataset), "preschool", 
                          "other"))))

mergedcollapse %>% 
  count(datasetsimple)
    
```
#The following section includes demographics for 2014 and onward for preschoolers and their families that appear in both the preschool file and the family_intake file. 

```{r make tables of overlap, echo=FALSE}

mergedpreschool %>% 
  ungroup %>% 
  count(rank)

mergedpreschool %>% 
  filter(school_year>=2014) %>% 
  filter(!is.na(`01-4: 4 What was your total FAMILY INCOME in the last 12 months?`)) %>% 
  group_by(`Service Modality`) %>%
  count(`Service Modality`) 



```




###The following section includes demographic tables by year, with the year starting at 2014. 

```{r make tables by year, echo=FALSE}
##make some tables

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(`Program Title`, `Contract Number`) %>%
  summarise(count = n()) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, Ethnicity) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, Ethnicity) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  ggplot(aes(x=school_year, y=perc, fill = Ethnicity), position = "dodge") +
  geom_col(position = "dodge")+
  labs(x="School Year", y="Percent") +
  ggtitle("Ethnicity by Year")
  

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, Language) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, Language) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  ggplot(aes(x=school_year, y=perc, fill = Language), position = "dodge") +
  geom_col(position = "dodge")+
  labs(x="School Year", y="Percent") +
  ggtitle("Language by Year")

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, `01-1: 1 What is your highest level of education`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, `01-2: 2 What is your current employment status?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year, `01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year,`01-3: 3 What is the marital status of the adults?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year) %>% 
  mutate(`01-7: 7 How many family members live in your household? (incl_ a` = as.numeric(`01-7: 7 How many family members live in your household? (incl_ a`)) %>% 
  summarise(meanHouseholdMembers = mean(`01-7: 7 How many family members live in your household? (incl_ a`, na.rm = TRUE)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year) %>% 
  mutate(`01-7: 7 How many family members live in your household? (incl_ a` = as.numeric(`01-7: 7 How many family members live in your household? (incl_ a`)) %>% 
  summarise(meanHouseholdMembers = mean(`01-7: 7 How many family members live in your household? (incl_ a`, na.rm = TRUE)) %>% 
  ggplot(aes(x=school_year, y=meanHouseholdMembers)) +
  geom_col()+
  labs(x="School Year") +
  ggtitle("Household Members by Year")
```

###The next section includes tables of demographics for the total population (from 2014 onward). 


```{r tables by total population, echo=FALSE}

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(Ethnicity) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(Language) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(`01-1: 1 What is your highest level of education`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  ggplot(aes(x=`01-1: 1 What is your highest level of education`, y=perc)) +
  geom_col()+
  ggtitle("Education by Year")

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(`01-1: 1 What is your highest level of education`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()


family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(`01-2: 2 What is your current employment status?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(`01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(`01-3: 3 What is the marital status of the adults?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  filter(school_year>=2014) %>% 
  group_by(school_year) %>% 
  mutate(`01-7: 7 How many family members live in your household? (incl_ a` = as.numeric(`01-7: 7 How many family members live in your household? (incl_ a`)) %>% 
  summarise(meanHouseholdMembers = mean(`01-7: 7 How many family members live in your household? (incl_ a`, na.rm = TRUE)) %>% 
   kable()
```

###Below are demographic tables by city. 


```{r tables by city, echo=FALSE}

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City, Ethnicity) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City, Language) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City, `01-1: 1 What is your highest level of education`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City, `01-2: 2 What is your current employment status?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
  kable()

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City, `01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City,`01-3: 3 What is the marital status of the adults?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intaketest %>% 
  filter(school_year>=2014) %>% 
  group_by(City) %>% 
  mutate(`01-7: 7 How many family members live in your household? (incl_ a` = as.numeric(`01-7: 7 How many family members live in your household? (incl_ a`)) %>% 
  summarise(meanHouseholdMembers = mean(`01-7: 7 How many family members live in your household? (incl_ a`, na.rm = TRUE)) %>% 
   kable()


```


```{r old tables, include=FALSE}
family_intake %>% 
  group_by(Zip) %>% 
  summarise(count = n())

family_intake %>% 
  group_by(Zip, Ethnicity) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>%  
   kable()

family_intake %>% 
  group_by(Zip, Language) %>%
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-1: 1 What is your highest level of education`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-2: 2 What is your current employment status?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  filter(Ethnicity=="07. White") %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  filter(Ethnicity=="04. Hispanic / Latino") %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-3: 3 What is the marital status of the adults?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip, `01-3: 3 What is the marital status of the adults?`, `01-4: 4 What was your total FAMILY INCOME in the last 12 months?`) %>% 
  summarise(count = n()) %>% 
  mutate(perc=(count/sum(count)*100)) %>% 
   kable()

family_intake %>% 
  group_by(Zip) %>% 
  mutate(`01-7: 7 How many family members live in your household? (incl_ a` = as.numeric(`01-7: 7 How many family members live in your household? (incl_ a`)) %>% 
  summarise(meanHouseholdMembers = mean(`01-7: 7 How many family members live in your household? (incl_ a`, na.rm = TRUE)) %>% 
   kable()
  


##make some tables
preschool %>%
  group_by(`Program Title`) %>%
  summarise(count = n()) %>% 
  kable()

import_member %>%
  group_by(`Program Title`) %>%
  summarise(count = n()) %>% 
  kable()

preschool %>%
  group_by(`Service Modality`) %>%
  summarise(count = n()) %>% 
  kable()

# 
# preschool %>% 
#   group_by(school_year, Ethnicity) %>% 
#   summarise(count = n()) %>% 
#   mutate(perc=(count/sum(count)*100)) 
# 
# preschool %>% 
#   group_by(Zip, Ethnicity) %>% 
#   summarise(count = n()) %>% 
#   mutate(perc=(count/sum(count)*100)) 
# 
# preschool %>% 
#   group_by(school_year, Language) %>% 
#   summarise(count = n()) %>% 
#   mutate(perc=(count/sum(count)*100)) 
#   
# preschool %>% 
#   group_by(Zip, Language) %>% 
#   summarise(count = n()) %>% 
#   mutate(perc=(count/sum(count)*100)) 
# 
# preschool %>% 
#   group_by(school_year, `Special Needs`) %>% 
#   summarise(count = n()) %>% 
#   mutate(perc=(count/sum(count)*100)) 
# 
# preschool %>% 
#   group_by(Zip, `Special Needs`) %>% 
#   summarise(count = n()) %>% 
#   mutate(perc=(count/sum(count)*100)) 

```



